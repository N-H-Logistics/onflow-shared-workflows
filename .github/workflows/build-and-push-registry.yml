name: Build and Push Docker Image

on:
  workflow_call:
    inputs:
      registry:
        required: true
        type: string
      image_name:
        required: true
        type: string
      dockerfile:
        required: false
        type: string
        default: docker/backend/Dockerfile
      context:
        required: false
        type: string
        default: .
      tag_prefix:   # ðŸ‘ˆ thÃªm input
        required: false
        type: string
        default: stg
    secrets:
      DIGITALOCEAN_ACCESS_TOKEN:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - id: meta
        run: |
          TAG_PREFIX=${{ inputs.tag_prefix }}
          TAG="${TAG_PREFIX}-$(echo $GITHUB_SHA | head -c7)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build container image
        run: |
          echo "Building with Dockerfile: ${{ inputs.dockerfile }}"
          echo "Context: ${{ inputs.context }}"
          docker build -f ${{ inputs.dockerfile }} \
            -t ${{ inputs.registry }}/${{ inputs.image_name }}:${{ steps.meta.outputs.tag }} \
            ${{ inputs.context }}

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600
      
      - name: Remove all old images (keep last 3)
        env:
          IMAGE_NAME: ${{ inputs.image_name }}
          CURRENT_TAG: ${{ steps.meta.outputs.tag }}
        run: |
          set -e

          echo "Repository: $IMAGE_NAME"
          echo "Current tag: $CURRENT_TAG"

          # Check repo exists
          if ! doctl registry repository list --no-header | awk '{print $1}' | grep -qx "$IMAGE_NAME"; then
            echo "Repository $IMAGE_NAME not found, skip cleanup"
            exit 0
          fi

          # Get all tags (sorted by date DESC)
          TAGS=$(doctl registry repository list-tags "$IMAGE_NAME" --no-header | sort -r -k3,3 | awk '{print $1}')

          echo "All tags:"
          echo "$TAGS"

          if [ -z "$TAGS" ]; then
            echo "No tags found"
            exit 0
          fi

          # Keep last 3 tags
          KEEP_TAGS=$(echo "$TAGS" | head -n 3)

          echo "Tags to keep:"
          echo "$KEEP_TAGS"

          for tag in $TAGS; do
            # Skip current running tag
            if [ "$tag" = "$CURRENT_TAG" ]; then
              echo "Skip current tag: $tag"
              continue
            fi

            # Skip 3 most recent tags
            if echo "$KEEP_TAGS" | grep -qx "$tag"; then
              echo "Keep tag: $tag"
              continue
            fi

            echo "Deleting tag: $tag"
            doctl registry repository delete-tag "$IMAGE_NAME" "$tag" --force
          done


      - name: Push image to registry
        run: docker push ${{ inputs.registry }}/${{ inputs.image_name }}:${{ steps.meta.outputs.tag }}
